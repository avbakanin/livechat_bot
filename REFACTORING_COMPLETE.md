# LiveChat Bot - Новая архитектура

## ✅ Рефакторинг завершен!

Проект успешно реорганизован согласно предложенной структуре. Новая архитектура следует принципам Clean Architecture и Domain-Driven Design.

## 📁 Новая структура проекта

```
app/
├── main.py                      # Точка входа
│
├── core/                        # Фундамент
│   ├── database.py              # Подключение к PostgreSQL (asyncpg)
│   ├── middleware.py             # Aiogram middleware
│   └── exceptions.py             # Кастомные исключения
│
├── config/                      # Настройки
│   ├── __init__.py
│   ├── database.py              # DSN для Postgres
│   ├── telegram.py              # Токен бота
│   └── openai.py                # Ключи OpenAI, URL API
│
├── domain/                      # Фичи (feature-based)
│   ├── user/
│   │   ├── handlers.py          # Хендлеры пользователя
│   │   ├── keyboards.py          # Кнопки для user
│   │   ├── messages.py          # Тексты для user
│   │   ├── services.py          # Бизнес-логика и SQL-запросы
│   │   └── queries.py           # SQL-запросы (PostgreSQL)
│   ├── subscription/
│   │   ├── handlers.py
│   │   ├── keyboards.py
│   │   ├── messages.py
│   │   ├── services.py
│   │   └── queries.py
│   ├── payment/
│   │   ├── handlers.py
│   │   ├── keyboards.py
│   │   ├── messages.py
│   │   ├── services.py
│   │   └── queries.py
│   └── message/
│       ├── handlers.py
│       ├── keyboards.py
│       ├── messages.py
│       ├── services.py          # Здесь делаются запросы к OpenAI
│       └── queries.py           # SQL-запросы для сообщений
│
├── shared/                      # Общие вещи
│   ├── keyboards/
│   │   └── common.py            # "Назад", "Да/Нет", универсальные кнопки
│   ├── messages/
│   │   └── common.py            # Общие тексты (ошибки, подсказки)
│   ├── utils/
│   │   ├── helpers.py
│   │   └── validators.py
│   └── models/                  # DTO / dataclass для каждой сущности
│       ├── base.py              # базовый класс, если нужен
│       ├── user.py
│       ├── subscription.py
│       ├── payment.py
│       └── message.py
```

## 🚀 Преимущества новой структуры

### ✅ Что улучшилось:

1. **Feature-based организация** - каждый домен изолирован
2. **Четкое разделение ответственности** - handlers, services, queries разделены
3. **Лучшая масштабируемость** - легко добавлять новые фичи
4. **Улучшенная читаемость** - код организован по функциональности
5. **Типизация** - добавлены модели данных с dataclass
6. **Обработка ошибок** - кастомные исключения для каждого домена
7. **Middleware** - централизованная обработка доступа и логирования
8. **Конфигурация** - разделена по типам (DB, Telegram, OpenAI)

### 🔄 Что изменилось:

**Было:**
- Все handlers в одном файле (223 строки!)
- Сервисы разбросаны по папкам без четкой логики
- Конфигурация смешана в одном файле
- Нет четкого разделения между бизнес-логикой и SQL-запросами

**Стало:**
- Каждая фича изолирована в своем домене
- SQL-запросы вынесены в отдельные файлы queries.py
- Конфигурация разделена по типам
- Добавлены модели данных для типизации
- Middleware для инъекции зависимостей

## 🛠 Технические улучшения

### Core модули:
- **database.py** - управление пулом соединений PostgreSQL
- **middleware.py** - AccessMiddleware, LoggingMiddleware, ServiceMiddleware
- **exceptions.py** - кастомные исключения для каждого домена

### Domain модули:
- **handlers.py** - обработчики Telegram событий
- **services.py** - бизнес-логика
- **queries.py** - SQL-запросы к базе данных
- **keyboards.py** - клавиатуры Telegram
- **messages.py** - текстовые шаблоны

### Shared модули:
- **models/** - типизированные модели данных
- **utils/** - вспомогательные функции и валидаторы
- **keyboards/common.py** - общие клавиатуры
- **messages/common.py** - общие сообщения

## 🎯 Готово к использованию

Новая структура полностью готова к использованию и включает:

- ✅ Все существующие функции бота
- ✅ Улучшенную архитектуру
- ✅ Лучшую организацию кода
- ✅ Готовность к масштабированию
- ✅ Типизацию и валидацию
- ✅ Централизованную обработку ошибок

## 🚀 Запуск

```bash
python app/main.py
```

Все зависимости и конфигурация остались прежними, но теперь код организован намного лучше!
