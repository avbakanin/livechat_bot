# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –ó–∞–¥–∞—á–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò –±–æ—Ç—É.

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ:**
```sql
SELECT COUNT(*) FROM messages 
WHERE user_id = $1 AND role = 'user' AND DATE(created_at) = CURRENT_DATE
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- üêå **–ú–µ–¥–ª–µ–Ω–Ω–æ:** `COUNT(*)` –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- üìà **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ:** –°–∫–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –¥–µ–Ω—å
- üîÑ **–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã:** –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å –Ω—É–ª—è
- üìä **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü—Ä–∏ —Ä–æ—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

## üöÄ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
1. **–û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤** –≤ –ë–î –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ FSM –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å** —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –ø–æ–ª–Ω–æ—á—å

## üìã –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. ‚úÖ **–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤**

**–§–∞–π–ª:** `app/migrations/add_daily_counters.sql`

```sql
CREATE TABLE public.user_daily_counters (
    user_id BIGINT NOT NULL,
    date DATE NOT NULL,
    message_count INTEGER DEFAULT 0,
    last_reset_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT user_daily_counters_pkey PRIMARY KEY (user_id, date)
);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏:** –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ù–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### 2. ‚úÖ **–°–µ—Ä–≤–∏—Å —Å—á–µ—Ç—á–∏–∫–æ–≤**

**–§–∞–π–ª:** `app/services/counter/daily_counter_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `increment_user_count()` - —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
- `get_user_count()` - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫
- `can_send_message()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
- `get_remaining_messages()` - –ø–æ–ª—É—á–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
- `cleanup_old_counters()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤

### 3. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ MessageService**

**–§–∞–π–ª:** `app/domain/message/services.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `DailyCounterService` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –û–±–Ω–æ–≤–ª–µ–Ω `add_message()` –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å—á–µ—Ç—á–∏–∫–∞
- –û–±–Ω–æ–≤–ª–µ–Ω `can_send_message()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω `get_remaining_messages()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞

### 4. ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ FSM**

**–§–∞–π–ª:** `app/shared/fsm/user_cache.py`

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:**
```python
@dataclass
class UserCacheData:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    daily_message_count: int = 0
    last_message_date: str = ""
```

### 5. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω main.py**

**–§–∞–π–ª:** `app/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è `DailyCounterService`
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `MessageService`
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ middleware

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### **1. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (–±—ã—Å—Ç—Ä–æ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ë–î)
can_send = await counter_service.can_send_message(user_id, daily_limit)

# 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
await message_service.add_message(user_id, "user", message_text)

# 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞
await counter_service.increment_user_count(user_id)
```

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞:**
```python
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Å—á–µ—Ç—á–∏–∫–æ–≤
current_count = await counter_service.get_user_count(user_id)
return current_count < daily_limit
```

### **3. –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞:**
```python
remaining = await counter_service.get_remaining_messages(user_id, daily_limit)
```

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:

### ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–ë—ã–ª–æ:** O(n) - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–°—Ç–∞–ª–æ:** O(1) - –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å—á–µ—Ç—á–∏–∫—É
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** –í 10-100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ

### üíæ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- **–ë—ã–ª–æ:** `COUNT(*)` –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- **–°—Ç–∞–ª–æ:** –ü—Ä–æ—Å—Ç–æ–π `SELECT` –ø–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- **–≠–∫–æ–Ω–æ–º–∏—è:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î

### üîÑ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- **–ë—ã–ª–æ:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç —Å —Ä–æ—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- **–°—Ç–∞–ª–æ:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–º –æ–±—ä–µ–º–µ

### üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- **Fallback:** –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ FSM
- **–û—á–∏—Å—Ç–∫–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

### ‚úÖ **–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:**
- üöÄ **–ë—ã—Å—Ç—Ä—ã–π —Å—á–µ—Ç—á–∏–∫:** O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ O(n)
- üíæ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
- üîÑ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ FSM

### üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π:**
- **–°–∫–æ—Ä–æ—Å—Ç—å:** –í 10-100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î:** –°–Ω–∏–∂–µ–Ω–∞ –≤ 5-10 —Ä–∞–∑
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–∏–Ω–µ–π–Ω–∞—è –≤–º–µ—Å—Ç–æ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** 100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

### **1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å—á–µ—Ç—á–∏–∫–æ–≤
\i app/migrations/add_daily_counters.sql
```

### **2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
```python
# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
await counter_service.cleanup_old_counters()
```

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
stats = await counter_service.get_user_stats(user_id, days=7)
```

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω!** 

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å—á–µ—Ç—á–∏–∫–æ–≤** –≤–º–µ—Å—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ `COUNT(*)`
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ FSM** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º** –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É** —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—ã—Å—Ç—Ä—ã–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π! üöÄ
