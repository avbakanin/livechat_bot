# –û—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## –û–±–∑–æ—Ä
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.

## üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (7 —Ç–∞–±–ª–∏—Ü)

### 1. **users** - –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ö–æ–ª–æ–Ω–∫–∏**: 12 –∫–æ–ª–æ–Ω–æ–∫
- **–ó–∞–ø–∏—Å–∏**: 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è**:
  - `id` (bigint) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `username`, `first_name`, `last_name` - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
  - `gender_preference` - –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'female')
  - `language` - —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'ru')
  - `personality_profile` (jsonb) - **—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞**
  - `subscription_status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'free')
  - `consent_given` - —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
  - `created_at`, `updated_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### 2. **messages** - –°–æ–æ–±—â–µ–Ω–∏—è (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
- **–ö–æ–ª–æ–Ω–∫–∏**: 5 –∫–æ–ª–æ–Ω–æ–∫
- **–ó–∞–ø–∏—Å–∏**: 3 —Å–æ–æ–±—â–µ–Ω–∏—è
- **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: `messages_202509` (—Å–µ–Ω—Ç—è–±—Ä—å 2025)
- **–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è**:
  - `user_id` - —Å–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  - `role` - —Ä–æ–ª—å (user/assistant)
  - `text` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  - `created_at` - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

### 3. **payments** - –ü–ª–∞—Ç–µ–∂–∏
- **–ö–æ–ª–æ–Ω–∫–∏**: 6 –∫–æ–ª–æ–Ω–æ–∫
- **–ó–∞–ø–∏—Å–∏**: 0 –∑–∞–ø–∏—Å–µ–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

### 4. **subscriptions** - –ü–æ–¥–ø–∏—Å–∫–∏
- **–ö–æ–ª–æ–Ω–∫–∏**: 10 –∫–æ–ª–æ–Ω–æ–∫
- **–ó–∞–ø–∏—Å–∏**: 0 –∑–∞–ø–∏—Å–µ–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 5. **user_daily_counters** - –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ö–æ–ª–æ–Ω–∫–∏**: 4 –∫–æ–ª–æ–Ω–∫–∏
- **–ó–∞–ø–∏—Å–∏**: 2 –∑–∞–ø–∏—Å–∏
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π

### 6. **bot_metrics** - –ú–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞
- **–ö–æ–ª–æ–Ω–∫–∏**: 6 –∫–æ–ª–æ–Ω–æ–∫
- **–ó–∞–ø–∏—Å–∏**: 20 –∑–∞–ø–∏—Å–µ–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (11 —Ñ—É–Ω–∫—Ü–∏–π)

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- `get_user_personality_profile(user_id)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ª–∏—á–Ω–æ—Å—Ç–∏
- `update_user_personality_profile(user_id, profile)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

### –°—á–µ—Ç—á–∏–∫–∏:
- `get_user_daily_count(user_id, date)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
- `increment_user_daily_count(user_id, date)` - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
- `reset_daily_counters_for_date(date)` - —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
- `cleanup_old_counters()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

### –ú–µ—Ç—Ä–∏–∫–∏:
- `get_metric(name)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- `set_metric(name, value)` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫–∏
- `increment_metric(name, increment)` - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏

### –ü–∞—Ä—Ç–∏—Ü–∏–∏:
- `ensure_messages_partition(month)` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
- `drop_messages_partition(month)` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏

## üìä –ò–Ω–¥–µ–∫—Å—ã (20 –∏–Ω–¥–µ–∫—Å–æ–≤)

### –û—Å–Ω–æ–≤–Ω—ã–µ:
- –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ `user_id` –¥–ª—è —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ –¥–∞—Ç–∞–º –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ:
- `idx_users_personality_profile` - GIN –∏–Ω–¥–µ–∫—Å –¥–ª—è JSONB –ø–æ–ª—è –∫–≤–∏–∑–∞
- `idx_users_language` - –∏–Ω–¥–µ–∫—Å –¥–ª—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_messages_user_id_created_at` - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–≤–∏–∑–∞

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
- **–¢–∞–±–ª–∏—Ü–∞**: `users`
- **–ü–æ–ª–µ**: `personality_profile` (JSONB)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```json
{
  "adventurous": 2.30,
  "analytical": 2.40,
  "creative": 0.00,
  "social": 0.00,
  "introverted": 1.60,
  "empathic": 0.00,
  "practical": 0.70,
  "free_spirited": 2.20
}
```

### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–≤–∏–∑–æ–º:
- `get_user_personality_profile(user_id)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- `update_user_personality_profile(user_id, profile)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- ‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–≤–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- ‚úÖ –õ–∏–º–∏—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∑–∞–ø—É—Å–∫—É

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–≤–∏–∑–∞ –≤ JSONB
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
