# üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞

## üìã **–û–ø–∏—Å–∞–Ω–∏–µ**

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/metrics`, –≤–∫–ª—é—á–∞—è –∑–∞–ø–∏—Å—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á.

## üîß **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**

### **1. –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (`record_new_user`)**

#### **–ì–¥–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:**
- **`app/domain/user/handlers.py`** - –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `cmd_start()`

#### **–õ–æ–≥–∏–∫–∞:**
```python
# Check if user is new before adding
user_exists = await user_service.get_user(user_id) is not None

await user_service.add_user(user_id, username, first_name, last_name)

# Record new user if this is their first time
if not user_exists:
    metrics_collector.record_new_user()
```

#### **–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏—Ö –±–æ—Ç–∞ –≤–ø–µ—Ä–≤—ã–µ
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `new_users_today`

### **2. –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (`record_active_user`)**

#### **–ì–¥–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:**
- **`app/domain/user/handlers.py`** - –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `cmd_start()`
- **`app/domain/message/handlers.py`** - –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `handle_message()`

#### **–õ–æ–≥–∏–∫–∞:**
```python
# Always record as active user
metrics_collector.record_active_user()
```

#### **–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö —Å –±–æ—Ç–æ–º
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `active_users_today`

### **3. –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤ (`record_successful_response`)**

#### **–ì–¥–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:**
- **`app/domain/message/handlers.py`** - –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò

#### **–õ–æ–≥–∏–∫–∞:**
```python
# Generate AI response with timing
start_time = time.time()
answer = await message_service.generate_response(user_id, message.text, gender)
response_time = time.time() - start_time

# Record successful response with timing
metrics_collector.record_successful_response(response_time)
```

#### **–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:**
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò
- –û–±–Ω–æ–≤–ª—è–µ—Ç `average_response_time`
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `successful_responses`

### **4. –ú–µ—Ç—Ä–∏–∫–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á**

#### **DailyResetTask:**
```python
# Record metrics for successful reset
metrics_collector.record_successful_response(0.0)  # Reset operation time

# Record error metrics
metrics_collector.record_failed_response("database")
```

#### **PartitionManagementTask:**
```python
# Record metrics for successful partition creation
metrics_collector.record_successful_response(0.0)

# Record error metrics
metrics_collector.record_failed_response("database")
```

#### **–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:**
- –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏
- –û—à–∏–±–∫–∏ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

## üìä **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ `/metrics`**

### **–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã:**

```python
{
    "uptime_seconds": –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö,
    "uptime_hours": –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —á–∞—Å–∞—Ö,
    "total_messages": –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π,
    "success_rate": –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤,
    "cache_hit_rate": –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à,
    "average_response_time": —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –ò–ò,
    "active_users_today": –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è,  # ‚Üê –ù–û–í–û–ï
    "new_users_today": –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è,        # ‚Üê –ù–û–í–û–ï
    "limit_exceeded_count": –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–π –ª–∏–º–∏—Ç–∞,
    "openai_errors": –æ—à–∏–±–∫–∏ OpenAI,
    "database_errors": –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö,                # ‚Üê –†–ê–°–®–ò–†–ï–ù–û
    "validation_errors": –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏,
}
```

## üîç **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫**

### **1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
- **`new_users_today`** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–ø–µ—Ä–≤—ã–µ –∑–∞–ø—É—Å—Ç–∏–≤—à–∏–µ `/start`
- **`active_users_today`** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **`average_response_time`** - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò
- **`success_rate`** - –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)

### **3. –û—à–∏–±–∫–∏:**
- **`openai_errors`** - –æ—à–∏–±–∫–∏ API OpenAI
- **`database_errors`** - –æ—à–∏–±–∫–∏ –ë–î (–≤–∫–ª—é—á–∞—è —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
- **`validation_errors`** - –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### **4. –ö—ç—à:**
- **`cache_hit_rate`** - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ FSM –∫—ç—à
- **`cache_hits`** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π
- **`cache_misses`** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–∞—Ö–æ–≤

## üöÄ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

### **1. –ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
- –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ—à–∏–±–æ–∫
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º

### **3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤

### **4. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã

## üìà **–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ `/metrics`**

```
üìä Bot Metrics

uptime_seconds: 86400
uptime_hours: 24.0
total_messages: 1250
success_rate: 98.5%
cache_hit_rate: 85.2%
average_response_time: 2.34s
active_users_today: 45
new_users_today: 12
limit_exceeded_count: 8
openai_errors: 15
database_errors: 3
validation_errors: 2
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞ `/metrics` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞:
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** - –Ω–æ–≤—ã–µ –∏ –∞–∫—Ç–∏–≤–Ω—ã–µ
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò
- ‚úÖ **–û—à–∏–±–∫–∏** - –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º
- ‚úÖ **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–ö—ç—à** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å FSM –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/metrics`.
