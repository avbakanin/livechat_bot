# 🌍 Команда /language - Руководство

## 📋 Обзор

Команда `/language` позволяет пользователям **принудительно выбирать язык интерфейса** бота. Это особенно полезно для пользователей, которые хотят изменить язык, отличный от автоматически определенного по их Telegram настройкам.

## 🚀 Функциональность

### **Основные возможности:**
- ✅ **Принудительный выбор языка** - пользователь может выбрать любой из 5 поддерживаемых языков
- ✅ **Визуальная индикация** - текущий язык отмечен галочкой ✅
- ✅ **Мгновенная смена** - язык меняется сразу после выбора
- ✅ **Интеграция с help** - доступна через кнопку "🌍 Выбрать язык" в help меню
- ✅ **Метрики** - записывается использование команды и смена языков

### **Поддерживаемые языки:**
- 🇷🇺 **Русский** (`ru`) - основной язык
- 🇬🇧 **Английский** (`en`) - международный
- 🇷🇸 **Сербский** (`sr`) - балканский регион
- 🇩🇪 **Немецкий** (`de`) - центральная Европа
- 🇪🇸 **Испанский** (`es`) - латинская Америка

## 🎯 Использование

### **Способ 1: Команда**
```
/language
```

### **Способ 2: Через Help меню**
1. Отправьте `/help`
2. Нажмите кнопку "🌍 Выбрать язык"
3. Выберите нужный язык

## 🔧 Техническая реализация

### **Файлы:**
- **`app/domain/user/handlers.py`** - обработчики команды и callbacks
- **`app/shared/keyboards/language.py`** - клавиатуры выбора языка
- **`locales/*/translations.json`** - переводы для всех языков

### **Обработчики:**
```python
@router.message(Command(commands=["language"]))
async def cmd_language(message: Message, i18n: I18nMiddleware):
    """Handle /language command to change interface language."""

@router.callback_query(F.data.startswith("lang_"))
async def handle_language_selection(callback: CallbackQuery, i18n: I18nMiddleware):
    """Handle language selection callback."""

@router.callback_query(F.data == "choose_language")
async def choose_language_help(callback: CallbackQuery, i18n: I18nMiddleware):
    """Handle choose language help callback."""
```

### **Клавиатуры:**
```python
def get_language_keyboard() -> InlineKeyboardMarkup:
    """Create language selection keyboard."""

def get_language_keyboard_with_current(current_language: str) -> InlineKeyboardMarkup:
    """Create language selection keyboard with current language marked."""
```

## 📝 Переводы

### **Ключи переводов:**
```json
{
  "commands": {
    "help": {
      "language_command": "/language - Выбрать язык интерфейса"
    },
    "language": {
      "title": "🌍 Выбор языка",
      "description": "Выберите язык интерфейса:",
      "changed": "✅ Язык изменен на {language}",
      "current": "Текущий язык: {language}",
      "available_languages": "Доступные языки:"
    }
  },
  "buttons": {
    "language_ru": "🇷🇺 Русский",
    "language_en": "🇬🇧 English",
    "language_sr": "🇷🇸 Српски",
    "language_de": "🇩🇪 Deutsch",
    "language_es": "🇪🇸 Español",
    "choose_language": "🌍 Выбрать язык"
  }
}
```

### **Примеры переводов:**

| Язык | Заголовок | Описание | Кнопка |
|------|-----------|----------|--------|
| 🇷🇺 Русский | "🌍 Выбор языка" | "Выберите язык интерфейса:" | "🌍 Выбрать язык" |
| 🇬🇧 English | "🌍 Language Selection" | "Choose interface language:" | "🌍 Choose language" |
| 🇷🇸 Српски | "🌍 Избор језика" | "Изаберите језик интерфејса:" | "🌍 Изабери језик" |
| 🇩🇪 Deutsch | "🌍 Sprachauswahl" | "Interface-Sprache wählen:" | "🌍 Sprache wählen" |
| 🇪🇸 Español | "🌍 Selección de idioma" | "Elige el idioma de la interfaz:" | "🌍 Elegir idioma" |

## 🎨 Интерфейс

### **Клавиатура выбора языка:**
```
┌─────────────────────────────────┐
│  🇷🇺 Русский ✅  │  🇬🇧 English    │
├─────────────────────────────────┤
│  🇷🇸 Српски     │  🇩🇪 Deutsch     │
├─────────────────────────────────┤
│  🇪🇸 Español                   │
├─────────────────────────────────┤
│  ↩️ Назад                       │
└─────────────────────────────────┘
```

### **Сообщения:**
- **Заголовок:** "🌍 Выбор языка"
- **Описание:** "Выберите язык интерфейса:"
- **Текущий язык:** "Текущий язык: RU"
- **Подтверждение:** "✅ Язык изменен на Русский"

## 📊 Метрики

### **Записываемые события:**
- **`language_command`** - использование команды `/language`
- **`language_changed_{lang}`** - смена языка (например, `language_changed_en`)

### **Примеры метрик:**
```python
safe_record_user_interaction(user_id, "language_command")
safe_record_user_interaction(user_id, "language_changed_en")
```

## 🔄 Логика работы

### **1. Команда `/language`:**
1. Пользователь отправляет `/language`
2. Бот определяет текущий язык
3. Показывает клавиатуру с отмеченным текущим языком
4. Записывает метрику использования команды

### **2. Выбор языка:**
1. Пользователь нажимает кнопку языка (например, `lang_en`)
2. Бот извлекает код языка (`en`)
3. Устанавливает новый язык в глобальном и локальном i18n
4. Обновляет сообщение с подтверждением
5. Записывает метрику смены языка

### **3. Через Help меню:**
1. Пользователь нажимает "🌍 Выбрать язык" в help
2. Бот показывает ту же клавиатуру выбора языка
3. Логика работы идентична команде `/language`

## ⚡ Оптимизация

### **Обработка ошибок:**
- **`MessageNotModified`** - игнорируется, просто подтверждается
- **`MessageToEditNotFound`** - показывается alert "Сообщение устарело"
- **Другие ошибки** - логируются и показывается alert "❌ Ошибка обновления"

### **Производительность:**
- **Кэширование** - переводы загружаются в память
- **Быстрая смена** - язык меняется мгновенно
- **Оптимизированные клавиатуры** - создаются только при необходимости

## 🧪 Тестирование

### **Проверенные аспекты:**
- ✅ **Импорт модулей** - все модули загружаются
- ✅ **Доступные языки** - все 5 языков присутствуют
- ✅ **Переводы** - все ключи переведены на каждый язык
- ✅ **Кнопки** - все кнопки языков работают
- ✅ **Клавиатуры** - создаются корректно
- ✅ **Смена языка** - работает мгновенно
- ✅ **Интеграция с help** - команда добавлена в help

### **Результаты тестирования:**
- **Функционал:** ✅ **100%** - все тесты прошли
- **Интеграция:** ✅ **100%** - команда интегрирована
- **Переводы:** ✅ **100%** - все языки поддерживаются

## 🎯 Преимущества

### **Для пользователей:**
- **Свобода выбора** - можно выбрать любой язык независимо от Telegram настроек
- **Удобство** - доступно как команда и через help меню
- **Наглядность** - текущий язык отмечен галочкой
- **Мгновенность** - язык меняется сразу

### **Для разработчиков:**
- **Метрики** - отслеживание использования языков
- **Расширяемость** - легко добавить новые языки
- **Надежность** - обработка всех ошибок
- **Производительность** - оптимизированная работа

## 🚀 Готовность

### **✅ ГОТОВО К ИСПОЛЬЗОВАНИЮ:**
- **Команда `/language`** работает корректно
- **Клавиатуры** создаются и отображаются правильно
- **Переводы** полные для всех 5 языков
- **Обработчики** интегрированы в систему
- **Метрики** записываются
- **Обработка ошибок** реализована
- **Тестирование** пройдено успешно

### **🎉 РЕЗУЛЬТАТ:**
**Команда `/language` полностью готова к продакшену!**

Пользователи теперь могут легко и удобно выбирать язык интерфейса бота, что значительно улучшает пользовательский опыт для международной аудитории.

---

*Документация создана: 2025-09-16 21:00:00*
*Статус: ГОТОВО К ПРОДАКШЕНУ* ✅
