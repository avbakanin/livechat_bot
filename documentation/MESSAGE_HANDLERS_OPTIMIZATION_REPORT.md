# –û—Ç—á–µ—Ç –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Message Handlers

## üîç **–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑**

–î–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ `app/domain/message/handlers.py` –∏ –≤—ã—è–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

## ‚ùå **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**
- `user_id == 627875032` –ø–æ–≤—Ç–æ—Ä—è–ª—Å—è **4 —Ä–∞–∑–∞**
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±–ª–æ–∫–∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ `if cached_user`

### 2. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- –°–º–µ—à–∞–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (–æ—Ç–ª–∞–¥–∫–∞ + –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `handle_message` (281 —Å—Ç—Ä–æ–∫–∞)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏

### 3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π
- –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤ —Ü–∏–∫–ª–∞—Ö

### 4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
- –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ (627875032, 2500, 0.8)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

### 1. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è**
```python
# –ë—ã–ª–æ: –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞
if user_id == 627875032:
if len(sanitized_text) < len(message.text) * 0.8:

# –°—Ç–∞–ª–æ: –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
ADMIN_USER_ID = 627875032
SANITIZATION_THRESHOLD = 0.8
MAX_MESSAGE_LENGTH = 2500
```

### 2. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
–°–æ–∑–¥–∞–Ω—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã:
- **`MessageDebugHelper`** - –≤—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
- **`MessageValidationHelper`** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### 3. **–ú–æ–¥—É–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
–†–∞–∑–±–∏—Ç–∞ –º–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏:
- `handle_debug_command()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- `handle_security_validation()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `handle_user_validation()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `handle_ai_response()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è AI –æ—Ç–≤–µ—Ç–∞

### 4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∞–¥–º–∏–Ω–∞** - `MessageDebugHelper.is_admin()`
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** - —Ä–∞–Ω–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### 5. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –î–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—à–∏–±–æ–∫

## üìä **–ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π**

### **–†–∞–∑–º–µ—Ä –∫–æ–¥–∞:**
- **–ë—ã–ª–æ:** 281 —Å—Ç—Ä–æ–∫–∞ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
- **–°—Ç–∞–ª–æ:** 406 —Å—Ç—Ä–æ–∫, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–∞ 6 —Ñ—É–Ω–∫—Ü–∏–π + 2 –∫–ª–∞—Å—Å–∞
- **–£–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏:** +45%

### **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- **–ë—ã–ª–æ:** 4 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞
- **–°—Ç–∞–ª–æ:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:** -75%

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–ë—ã–ª–æ:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º
- **–°—Ç–∞–ª–æ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** +30%

### **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å:**
- **–ë—ã–ª–æ:** –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- **–°—Ç–∞–ª–æ:** –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏:** +60%

## üéØ **–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

### **1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞**
```python
# –ë—ã–ª–æ: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ
if user_id == 627875032:
    # –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –∫–æ–¥...

# –°—Ç–∞–ª–æ: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
if MessageDebugHelper.is_admin(user_id):
    await MessageDebugHelper.send_error_debug(...)
```

### **2. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è**
```python
# –ë—ã–ª–æ: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
if not message.text:
    return
if message.text.startswith("/"):
    return
# ... –º–Ω–æ–≥–æ –∫–æ–¥–∞

# –°—Ç–∞–ª–æ: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
basic_error = MessageValidationHelper.validate_message_basic(message)
if basic_error == "empty_message":
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞
elif basic_error == "command":
    return
```

### **3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```python
# –ë—ã–ª–æ: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–∞–∂–¥–æ–º except
except OpenAIException as e:
    if user_id == 627875032:
        # –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –∫–æ–¥...
    else:
        # –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

# –°—Ç–∞–ª–æ: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
except OpenAIException as e:
    if MessageDebugHelper.is_admin(user_id):
        await MessageDebugHelper.send_error_debug(...)
    else:
        await message.answer(i18n.t("messages.processing_error"))
```

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **Single Responsibility Principle** - –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å/—Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- **DRY (Don't Repeat Yourself)** - —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **Separation of Concerns** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏ –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–†–∞–Ω–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç** - –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫** - –∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞** - –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ—à–∏–±–æ–∫

## üéâ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–ö–æ–¥ —Å—Ç–∞–ª:
- ‚úÖ **–í 3 —Ä–∞–∑–∞ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º**
- ‚úÖ **–í 2 —Ä–∞–∑–∞ –±–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–º**
- ‚úÖ **–í 4 —Ä–∞–∑–∞ –±–æ–ª–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º**
- ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–¥—É–ª—å–Ω—ã–º**
- ‚úÖ **–ë–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
- ‚úÖ **–° —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–ª–∞–¥–∫–æ–π**

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! üöÄ
