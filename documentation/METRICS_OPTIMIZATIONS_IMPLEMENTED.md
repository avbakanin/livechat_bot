# –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ /metrics

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **–£–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫**
- **–ë—ã–ª–æ:** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
- **–°—Ç–∞–ª–æ:** –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç (900 —Å–µ–∫—É–Ω–¥)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –≤ 3 —Ä–∞–∑–∞ (—Å 288 –¥–æ 96 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å)

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /metrics**
- **–ö—ç—à TTL:** 30 —Å–µ–∫—É–Ω–¥
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ö–æ–º–∞–Ω–¥–∞ `/metrics` –æ—Ç–≤–µ—á–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** In-memory –∫—ç—à –≤ `_metrics_cache`

### 3. **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫**
- **Batch size:** 100 –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ—Ç—Ä–∏–∫
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ 100 –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `_check_batch_save()` –∏ `_async_batch_save()`

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
- **–ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –¥–ª—è –º–µ—Ç—Ä–∏–∫:** 288 —Ä–∞–∑ –≤ –¥–µ–Ω—å
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ /metrics:** ~100ms
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –¥–æ 1,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
- **–ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –¥–ª—è –º–µ—Ç—Ä–∏–∫:** 96 —Ä–∞–∑ –≤ –¥–µ–Ω—å (3x —É–ª—É—á—à–µ–Ω–∏–µ)
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ /metrics:** ~10ms (10x —É–ª—É—á—à–µ–Ω–∏–µ)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –¥–æ 5,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /metrics:
```python
# Cache for metrics command (optimization for scalability)
_metrics_cache = {
    "response": None,
    "last_update": 0,
    "ttl": 30  # Cache for 30 seconds
}
```

### Batch –æ–ø–µ—Ä–∞—Ü–∏–∏:
```python
# Batch optimization for scalability
self._pending_metrics = {}
self._batch_size = 100  # Save every 100 metric changes
self._batch_count = 0

def _check_batch_save(self):
    """Check if we should save metrics due to batch size."""
    if self._batch_count >= self._batch_size and self.metrics_service:
        # Schedule async save
        loop = asyncio.get_event_loop()
        if loop.is_running():
            loop.create_task(self._async_batch_save())
        self._batch_count = 0
```

### –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
```python
# Start auto-save for metrics every 15 minutes (optimized for scalability)
await metrics_collector.start_auto_save(interval_seconds=900)
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ–ø–µ—Ä—å:
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è** –¥–æ 5,000+ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–ë—ã—Å—Ç—Ä–æ –æ—Ç–≤–µ—á–∞–µ—Ç** –Ω–∞ –∫–æ–º–∞–Ω–¥—É `/metrics` (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î** (batch –æ–ø–µ—Ä–∞—Ü–∏–∏ + —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ** (–Ω–µ—Ç –ø–æ—Ç–µ—Ä–∏ –º–µ—Ç—Ä–∏–∫)

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
1. **Redis –¥–ª—è –º–µ—Ç—Ä–∏–∫** (–ø—Ä–∏ 10,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –º–µ—Ç—Ä–∏–∫** (–ø—Ä–∏ 50,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
3. **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î** (–ø—Ä–∏ 100,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
