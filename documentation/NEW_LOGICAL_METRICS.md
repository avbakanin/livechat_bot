# üéØ –ù–æ–≤–∞—è –ª–æ–≥–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫

## üìã **–ü—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã**

### **‚ùå –ë—ã–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
# –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞
active_users_today = 3  # ‚ùå –ù–ï —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏!

# –ö–∞–∫ –ø–æ–ª—É—á–∞–ª–æ—Å—å 3:
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123: /start (+1) + —Å–æ–æ–±—â–µ–Ω–∏–µ (+1) = 2
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 456: /start (+1) = 1  
# –ò—Ç–æ–≥–æ: 3 (–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ 2!)
```

### **‚ùå –ü—Ä–æ–±–ª–µ–º—ã:**
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ** - `active_users_today` –Ω–µ —Å—á–∏—Ç–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–æ–≤
- **–ë–µ—Å–ø–æ–ª–µ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª —Ä–µ–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- **–ü—É—Ç–∞–Ω–∏—Ü–∞** - –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é

## ‚úÖ **–ù–æ–≤–∞—è –ª–æ–≥–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**

### **üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã:**
1. **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è vs —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
2. **–õ–æ–≥–∏—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è** - –º–µ—Ç—Ä–∏–∫–∞ = —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
3. **–ü–æ–ª–µ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - —Ä–µ–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
4. **Deduplication** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### **üìä –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

#### **1. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
```python
unique_active_users_today: int = 0  # ‚úÖ –†–µ–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```

#### **2. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:**
```python
total_interactions_today: int = 0   # ‚úÖ –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–∫–æ–º–∞–Ω–¥—ã + —Å–æ–æ–±—â–µ–Ω–∏—è)
messages_sent_today: int = 0        # ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
commands_used_today: int = 0        # ‚úÖ –ö–æ–º–∞–Ω–¥—ã (/start, /help, etc.)
```

#### **3. –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
```python
new_users_today: int = 0            # ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø–µ—Ä–≤—ã–π /start)
```

## üîß **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞**

### **1. –ú–µ—Ç–æ–¥ `record_user_interaction()`:**
```python
def record_user_interaction(self, user_id: int, interaction_type: str):
    """Record any user interaction with deduplication."""
    # –í—Å–µ–≥–¥–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    self.metrics.total_interactions_today += 1
    
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–∏–ø –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    if interaction_type == "message":
        self.metrics.messages_sent_today += 1
    elif interaction_type == "command":
        self.metrics.commands_used_today += 1
    
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if user_id not in self.metrics.daily_user_ids:
        self.metrics.daily_user_ids.add(user_id)
        self.metrics.unique_active_users_today += 1
```

### **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:**

#### **–ö–æ–º–∞–Ω–¥—ã (`/start`, `/help`):**
```python
# –í cmd_start()
safe_record_user_interaction(user_id, "command")
```

#### **–°–æ–æ–±—â–µ–Ω–∏—è:**
```python
# –í handle_message()
safe_record_user_interaction(user_id, "message")
```

## üìà **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

### **–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
```
User 123: /start command
User 123: message  
User 456: /start command
User 123: another message
User 789: /help command
New user registered
```

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
üìä New Logical Metrics Results:
  unique_active_users_today: 3     ‚úÖ 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (123, 456, 789)
  total_interactions_today: 5      ‚úÖ 5 –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –≤—Å–µ–≥–æ
  messages_sent_today: 2           ‚úÖ 2 —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  commands_used_today: 3           ‚úÖ 3 –∫–æ–º–∞–Ω–¥—ã (/start, /start, /help)
  new_users_today: 1               ‚úÖ 1 –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```

### **–ê–Ω–∞–ª–∏–∑:**
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 3 (123, 456, 789)
- **–í—Å–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π:** 5 (3 –∫–æ–º–∞–Ω–¥—ã + 2 —Å–æ–æ–±—â–µ–Ω–∏—è)
- **–ö–æ–º–∞–Ω–¥:** 3 (/start, /start, /help)
- **–°–æ–æ–±—â–µ–Ω–∏–π:** 2 (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123)
- **–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 1

## üéØ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã**

### **1. ‚úÖ –õ–æ–≥–∏—á–Ω–æ—Å—Ç—å:**
- **–ù–∞–∑–≤–∞–Ω–∏–µ = —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ** - `unique_active_users_today` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü–æ–Ω—è—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** - –∫–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ –∏–º–µ–µ—Ç —á–µ—Ç–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

### **2. ‚úÖ –ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å:**
- **–†–µ–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** - –º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** - –≤–∏–¥–Ω–æ –∫–æ–º–∞–Ω–¥—ã vs —Å–æ–æ–±—â–µ–Ω–∏—è
- **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **3. ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å:**
- **Deduplication** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å** - –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Ä–∞–∂–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å

## üîÑ **–ú–∏–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã**

### **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
```python
def record_active_user(self):
    """DEPRECATED: Use record_user_interaction instead."""
    logging.warning("record_active_user() is deprecated. Use record_user_interaction(user_id, type) instead.")
    self.metrics.total_interactions_today += 1
```

### **–ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
```python
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (deprecated)
safe_record_metric('record_active_user')

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (recommended)
safe_record_user_interaction(user_id, "command")  # –î–ª—è –∫–æ–º–∞–Ω–¥
safe_record_user_interaction(user_id, "message")  # –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
```

## üìä **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `/metrics`**

### **–ù–æ–≤—ã–π –≤—ã–≤–æ–¥:**
```
üìä Bot Metrics

uptime_seconds: 15430.296739
uptime_hours: 4.286193538611111
total_messages_processed: 1
success_rate: 100.0%
average_response_time: 0.00s
limit_exceeded_count: 0

unique_active_users_today: 3        ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
total_interactions_today: 5         ‚úÖ –í—Å–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
messages_sent_today: 2              ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
commands_used_today: 3              ‚úÖ –ö–æ–º–∞–Ω–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
new_users_today: 1                  ‚úÖ –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

cache_hit_rate: 0.0%
openai_errors: 0
database_errors: 0
validation_errors: 0
```

## üóÑÔ∏è **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î**

### **–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ `bot_metrics`:**
```sql
INSERT INTO public.bot_metrics (metric_name, metric_value) VALUES
('total_interactions_today', 0),      -- –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
('unique_active_users_today', 0),     -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
('messages_sent_today', 0),           -- –°–æ–æ–±—â–µ–Ω–∏—è
('commands_used_today', 0),           -- –ö–æ–º–∞–Ω–¥—ã
('new_users_today', 0),               -- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```

### **–£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```sql
-- –£–¥–∞–ª–µ–Ω–æ: 'active_users_today' (–∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ unique_active_users_today)
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

**–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ª–æ–≥–∏—á–Ω–∞ –∏ –ø–æ–ª–µ–∑–Ω–∞:**

- ‚úÖ **–õ–æ–≥–∏—á–Ω–æ—Å—Ç—å** - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é
- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ **–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å** - —Ä–µ–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –ø–æ–Ω—è—Ç–Ω—ã–µ –∏ —á–µ—Ç–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

**–¢–µ–ø–µ—Ä—å `unique_active_users_today: 3` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!** üéØ
