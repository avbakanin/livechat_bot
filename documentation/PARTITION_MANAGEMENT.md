# üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üìã **–û–ø–∏—Å–∞–Ω–∏–µ**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π. –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cron –∑–∞–¥–∞—á –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏.

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **`PartitionManagementTask`** - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –∑–∞–¥–∞—á–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏
2. **SQL —Ñ—É–Ω–∫—Ü–∏–∏** - `ensure_messages_partition()` –∏ `drop_messages_partition()`
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py** - –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

## üìÅ **–§–∞–π–ª—ã**

### **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `app/shared/tasks/partition_management_task.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–¥–∞—á–∏
- `documentation/PARTITION_MANAGEMENT.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `app/shared/tasks/__init__.py` - —ç–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
- `app/main.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏

## üîß **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**

### **1. PartitionManagementTask –∫–ª–∞—Å—Å:**

```python
class PartitionManagementTask:
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    
    async def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏."""
        
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏."""
        
    async def _partition_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞–¥–∞—á–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏."""
        
    async def force_create_partition(self, target_date: date):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã."""
        
    async def force_drop_partition(self, target_date: date):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã."""
        
    async def get_partition_status(self) -> list:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π."""
```

### **2. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

#### **–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (25 —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞):**
```python
def _get_next_25th(self) -> datetime:
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ 25 —á–∏—Å–ª–∞."""
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ 25 —á–∏—Å–ª–∞
    # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
```

#### **–£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (1 —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞):**
```python
def _get_next_1st(self) -> datetime:
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ 1 —á–∏—Å–ª–∞."""
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ 1 —á–∏—Å–ª–∞
    # –£–¥–∞–ª—è–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –∑–∞ 2 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
```

### **3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py:**

```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
partition_management_task = PartitionManagementTask(pool)

# –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏
await partition_management_task.start()

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ (–≤ finally –±–ª–æ–∫–µ)
await partition_management_task.stop()
```

## üöÄ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (25 —á–∏—Å–ª–æ):**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 05:00 25 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è

2. **–£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (1 —á–∏—Å–ª–æ):**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é –∑–∞ 2 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 05:00 1 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –∂–¥–µ—Ç 1 —á–∞—Å –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
   - –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   - Graceful shutdown –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞

### **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

1. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
   - `force_create_partition()` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ª—é–±–æ–π –¥–∞—Ç—ã
   - `force_drop_partition()` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ª—é–±–æ–π –¥–∞—Ç—ã

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - `get_partition_status()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üìä **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

### **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
Partition management task started
Partition management task: waiting 43200 seconds until next partition creation
Partition management task: creating partition for 2025-10-01
Partition management task: partition creation result: success
Partition management task: waiting 43200 seconds until next partition cleanup
Partition management task: dropping partition for 2025-07-01
Partition management task: partition drop result: success
Partition management task stopped
```

### **–û—à–∏–±–∫–∏:**
```
Partition management task error: Connection timeout
Partition management task: waiting 3600 seconds before retry
```

## üîÑ **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª**

### **–ó–∞–ø—É—Å–∫:**
1. –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
2. –°–æ–∑–¥–∞–µ—Ç—Å—è `PartitionManagementTask`
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
4. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ 25 —á–∏—Å–ª–∞
5. –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è

### **–†–∞–±–æ—Ç–∞:**
1. –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ 25 —á–∏—Å–ª–∞
2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
3. –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ 1 —á–∏—Å–ª–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
4. –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∑–∞ 2 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
5. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–∂–∏–¥–∞–Ω–∏—é —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞

### **–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
2. –û—Ç–º–µ–Ω–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
3. Graceful shutdown
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

## ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞–¥ cron**

### **1. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–æ–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–µ, —á—Ç–æ –∏ –±–æ—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö cron –¥–µ–º–æ–Ω–æ–≤

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ, —á—Ç–æ –∏ –±–æ—Ç
- –õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–µ—Ç—Ä–∏–∫ –±–æ—Ç–∞

### **3. –ì–∏–±–∫–æ—Å—Ç—å:**
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –±–æ—Ç–∞

### **4. –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron
- –†–∞–±–æ—Ç–∞–µ—Ç "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"
- –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–¢–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –±–æ—Ç. –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.

### **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:**
- **25 —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 05:00** - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
- **1 —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 05:00** - —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∑–∞ 2 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `bot.log` —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç–∏—Ü–∏–π —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
