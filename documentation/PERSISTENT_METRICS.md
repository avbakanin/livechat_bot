# üíæ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞

## üìã **–ü—Ä–æ–±–ª–µ–º–∞**

–†–∞–Ω–µ–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/metrics` **–æ–±–Ω—É–ª—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ** `main.py` –∏–∑-–∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏.

## üîß **–†–µ—à–µ–Ω–∏–µ**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ PostgreSQL –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### **1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**

#### **–¢–∞–±–ª–∏—Ü–∞ `bot_metrics`:**
```sql
CREATE TABLE public.bot_metrics (
    id SERIAL PRIMARY KEY,
    metric_name TEXT NOT NULL UNIQUE,
    metric_value BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **–§—É–Ω–∫—Ü–∏–∏ –ë–î:**
```sql
-- –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
public.get_metric(metric_name TEXT) RETURNS BIGINT

-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
public.set_metric(metric_name TEXT, value BIGINT) RETURNS VOID

-- –£–≤–µ–ª–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
public.increment_metric(metric_name TEXT, increment BIGINT DEFAULT 1) RETURNS VOID
```

### **2. –°–µ—Ä–≤–∏—Å –º–µ—Ç—Ä–∏–∫**

#### **`MetricsService` (`app/services/metrics/metrics_service.py`):**
```python
class MetricsService:
    async def get_metric(self, metric_name: str) -> int
    async def set_metric(self, metric_name: str, value: int) -> None
    async def increment_metric(self, metric_name: str, increment: int = 1) -> None
    async def get_all_metrics(self) -> Dict[str, int]
    async def save_metrics(self, metrics: Dict[str, Any]) -> None
    async def load_metrics(self) -> Dict[str, int]
```

### **3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π MetricsCollector**

#### **–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
class MetricsCollector:
    async def load_from_database(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    
    async def save_to_database(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î"""
    
    async def start_auto_save(self, interval_seconds: int = 300):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç"""
    
    async def stop_auto_save(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
```

## üîÑ **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –º–µ—Ç—Ä–∏–∫**

### **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:**
```python
# 1. –°–æ–∑–¥–∞–µ—Ç—Å—è MetricsService —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î
metrics_service = MetricsService(pool)

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è MetricsCollector —Å —Å–µ—Ä–≤–∏—Å–æ–º
metrics_collector.metrics_service = metrics_service

# 3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ë–î
await metrics_collector.load_from_database()

# 4. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
await metrics_collector.start_auto_save(interval_seconds=300)
```

### **–í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:**
```python
# –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ
metrics_collector.record_message_processed()
metrics_collector.record_successful_response(response_time)

# –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
# (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ)
```

### **–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞:**
```python
# 1. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î
await metrics_collector.save_to_database()

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
await metrics_collector.stop_auto_save()
```

## üìä **–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `total_messages_processed` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- `successful_responses` - —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- `failed_responses` - –Ω–µ—É–¥–∞—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- `limit_exceeded_count` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤
- `active_users_today` - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è
- `new_users_today` - –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è

### **–ú–µ—Ç—Ä–∏–∫–∏ –æ—à–∏–±–æ–∫:**
- `openai_errors` - –æ—à–∏–±–∫–∏ OpenAI API
- `database_errors` - –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `validation_errors` - –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### **–ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞:**
- `cache_hits` - –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à
- `cache_misses` - –ø—Ä–æ–º–∞—Ö–∏ –∫—ç—à–∞

### **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- `total_response_time` - –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤
- `average_response_time` - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤
- `uptime_seconds` - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

### **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏:**
- `started_at` - –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (Unix timestamp)
- `last_reset` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ (Unix timestamp)

## üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
- **–§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º:** –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É

### **–õ–æ–≥–∏–∫–∞:**
```python
async def _auto_save_loop():
    while self._auto_save_enabled:
        try:
            await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç
            if self._auto_save_enabled:
                await self.save_to_database()
        except asyncio.CancelledError:
            break
        except Exception as e:
            logging.error(f"Error in auto-save loop: {e}")
```

## üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**

### **1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤:**
- –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏–º–∞–ª—å–Ω–∞ (–º–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω—É—Ç)

### **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –û—à–∏–±–∫–∏ –ë–î –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### **3. Graceful shutdown:**
- –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
- –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

## üìà **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

### **1. –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (uptime)

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É
- ‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ SQL —Ñ—É–Ω–∫—Ü–∏–∏

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î
- ‚úÖ Graceful shutdown

## üîç **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

### **–õ–æ–≥–∏:**
```
üìä Loaded metrics from database
üìä Started auto-save every 300 seconds
üìä Saved metrics to database
üìä Stopped auto-save
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫
SELECT metric_name, metric_value, updated_at 
FROM public.bot_metrics 
ORDER BY updated_at DESC;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
SELECT metric_name, metric_value, updated_at 
FROM public.bot_metrics 
WHERE metric_name = 'total_messages_processed';
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/metrics` **–ù–ï –æ–±–Ω—É–ª—è—é—Ç—Å—è** –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ:

- ‚úÖ **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –º–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úÖ **–ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- ‚úÖ **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ **Graceful shutdown** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (uptime) —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞!**
