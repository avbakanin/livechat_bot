# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ –±–æ—Ç–∞

## üéØ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

–£—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤ —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞.

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–ª—é—á `persons` –≤ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤

**–§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã:**
- `locales/ru/translations.json` - —Ä—É—Å—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- `locales/en/translations.json` - –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–∞ `persons`:**
```json
{
  "persons": {
    "gender": {
      "male": ["–¢—ã –º—É–∂—á–∏–Ω–∞"],
      "female": ["–¢—ã –∂–µ–Ω—â–∏–Ω–∞"]
    },
    "temperament": {
      "sanguine": "–°–∞–Ω–≥–≤–∏–Ω–∏–∫: —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π.",
      "choleric": "–•–æ–ª–µ—Ä–∏–∫: –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–π, –∞–∫—Ç–∏–≤–Ω—ã–π, —Å—Ç—Ä–∞—Å—Ç–Ω—ã–π.",
      "phlegmatic": "–§–ª–µ–≥–º–∞—Ç–∏–∫: —Å–ø–æ–∫–æ–π–Ω—ã–π, —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω—ã–π, –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω—ã–π.",
      "melancholic": "–ú–µ–ª–∞–Ω—Ö–æ–ª–∏–∫: —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π, –∑–∞–¥—É–º—á–∏–≤—ã–π, —Å–∫–ª–æ–Ω–Ω—ã–π –∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑—É."
    },
    "traits": {
      "mood": { "cheerful": "...", "serious": "..." },
      "emotionality": { "emotional": "...", "calm": "..." },
      "approach": { "direct": "...", "gentle": "..." },
      "style": { "playful": "...", "thoughtful": "..." },
      "focus": { "analytical": "...", "creative": "..." },
      "social_orientation": { "extroverted": "...", "introverted": "..." },
      "time_orientation": { "progressive": "...", "traditional": "..." },
      "conflict_style": { "assertive": "...", "accommodating": "..." },
      "communication_format": { "detailed": "...", "concise": "..." },
      "values_focus": { "pragmatic": "...", "idealistic": "..." },
      "reaction_to_newness": { "cautious": "...", "enthusiastic": "..." }
    }
  }
}
```

### 2. ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `PersonaService`

**–§–∞–π–ª:** `app/services/persona/persona_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `generate_dynamic_persona(user_gender)` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂
- `get_persona_for_gender(user_gender)` - –ø–æ–ª—É—á–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
- `get_persona_info(user_gender)` - –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`male`/`female`)
2. –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –ø–æ–ª –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
3. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –∏–∑ 4 —Ç–∏–ø–æ–≤
4. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ –æ–¥–Ω–æ–π —á–µ—Ä—Ç–µ –∏–∑ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã (11 –≥—Ä—É–ø–ø)
5. –°–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI

### 3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `MessageService`

**–§–∞–π–ª:** `app/domain/message/services.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `persona_service` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `generate_response()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `PersonaService`

**–õ–æ–≥–∏–∫–∞:**
```python
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
if self.persona_service:
    system_prompt = self.persona_service.get_persona_for_gender(gender_preference)
else:
    system_prompt = self._get_system_prompt(gender_preference)  # fallback
```

### 4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª `main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω `PersonaService`
- –°–æ–∑–¥–∞–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä `PersonaService` —Å `I18nMiddleware`
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `MessageService`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä `I18nMiddleware` –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# Create I18n middleware first to use in PersonaService
i18n_middleware = I18nMiddleware()
persona_service = PersonaService(i18n_middleware)

message_service = MessageService(pool, openai_client, persona_service)
```

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### 1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–ª –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞ (`male`/`female`)
- –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ –ø–æ–ª–∞
- –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –∏ —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

### 2. **–ü—Ä–∏–º–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:**
```
–¢—ã –∂–µ–Ω—â–∏–Ω–∞. –ú–µ–ª–∞–Ω—Ö–æ–ª–∏–∫: —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π, –∑–∞–¥—É–º—á–∏–≤—ã–π, —Å–∫–ª–æ–Ω–Ω—ã–π –∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑—É. 
–î–æ–±–∞–≤–ª—è–π –ª—ë–≥–∫–∏–π —é–º–æ—Ä –∏ –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏ –ø–æ–∑–∏—Ç–∏–≤. –ù–µ —Å–∫—Ä—ã–≤–∞–π —ç–º–æ—Ü–∏–∏, –æ—Ç–≤–µ—á–∞–π —è—Ä–∫–æ –∏ –∂–∏–≤–æ. 
–ë—É–¥—å –º—è–≥–∫–∏–º –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–º –≤ —Å–ª–æ–≤–∞—Ö. –î–æ–±–∞–≤–ª—è–π –∏–≥—Ä–∏–≤—ã–µ –Ω–æ—Ç–∫–∏ –≤ –æ–±—â–µ–Ω–∏–µ. 
–†–∞–∑–±–∏—Ä–∞–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ. –ë—É–¥—å –æ–±—â–∏—Ç–µ–ª—å–Ω—ã–º, –∏–Ω–∏—Ü–∏–∏—Ä—É–π –¥–∏–∞–ª–æ–≥, 
–≥–æ–≤–æ—Ä–∏ –æ –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö. –ß–∞—â–µ —Å–º–æ—Ç—Ä–∏ –≤ –±—É–¥—É—â–µ–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. 
–°—Ç—Ä–µ–º–∏—Å—å –∫ –≥–∞—Ä–º–æ–Ω–∏–∏, –∏–¥–∏ –Ω–∞ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã. –î–∞–≤–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ, –æ–±—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏. 
–†–∞—Å—Å—É–∂–¥–∞–π —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –º–æ—Ä–∞–ª–∏, –∏–¥–µ–∞–ª–æ–≤ –∏ –≤—ã—Å—à–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. 
–í—Å—Ç—Ä–µ—á–∞–π –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω—ã —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º –∏ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ–º.
```

### 3. **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ `i18n`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

### ‚úÖ **–î–∏–Ω–∞–º–∏—á–Ω–æ—Å—Ç—å:**
- –ö–∞–∂–¥—ã–π —Ä–∞–∑ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–≤ –∏ —Å—Ç–∏–ª–µ–π –æ–±—â–µ–Ω–∏—è
- –ë–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### ‚úÖ **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –≥–æ–≤–æ—Ä—è—Ç –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–µ—Ä–µ–≤–æ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —è–∑—ã–∫–∏

### ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—ã
- –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —á–µ—Ä—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ FSM
- Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
I18nMiddleware ‚Üí PersonaService ‚Üí MessageService ‚Üí OpenAI
```

### **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `PersonaService` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `I18nMiddleware`
- `MessageService` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `PersonaService`
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ `main.py`

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `PersonaService`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- Graceful degradation

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç:

–¢–µ–ø–µ—Ä—å –±–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –í—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª–∞ –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞
- –°–ª—É—á–∞–π–Ω–æ–≥–æ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç–∞ (4 —Ç–∏–ø–∞)
- –°–ª—É—á–∞–π–Ω—ã—Ö —á–µ—Ä—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ (11 –≥—Ä—É–ø–ø –ø–æ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
- –Ø–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç **–±–æ–ª–µ–µ –∂–∏–≤–æ–µ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ** –æ–±—â–µ–Ω–∏–µ —Å –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω–æ–º! üöÄ
