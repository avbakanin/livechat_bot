# üîÑ –ê–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥—ã /restart

## üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞ /restart

### 1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã**
```python
@router.message(Command(commands=[BotCommands.RESTART]))
async def cmd_restart(message: Message, i18n: I18nMiddleware, cached_user: UserCacheData = None):
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/restart`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ñ–ª–∞–≥ `cached_user.is_restarted` - –µ—Å–ª–∏ –±–æ—Ç —É–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### 2. **–î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**
```html
üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞?

–í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏  
‚Ä¢ –ö—ç—à

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.
```

**–ö–Ω–æ–ø–∫–∏:**
- ‚úÖ **–î–∞** (`restart_confirm`)
- ‚ùå **–ù–µ—Ç** (`restart_cancel`)

### 3. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**
```python
async def restart_confirm(callback: CallbackQuery, user_service: UserService, i18n: I18nMiddleware):
    await user_service.restart_user_state(user_id)
```

## üóÑÔ∏è –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **–§—É–Ω–∫—Ü–∏—è `restart_user_state(user_id)`:**
```python
async def restart_user_state(self, user_id: int) -> None:
    """Restart user state - clear messages but keep consent and go to gender selection."""
```

### **1. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π**
```sql
DELETE FROM messages WHERE user_id = $1
```
- **–¢–∞–±–ª–∏—Ü–∞:** `messages`
- **–ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è:** –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏)
- **–§—É–Ω–∫—Ü–∏—è:** `delete_user_messages(user_id)`

### **2. –°–±—Ä–æ—Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª–∞**
```sql
UPDATE users SET gender_preference = NULL WHERE id = $1
```
- **–¢–∞–±–ª–∏—Ü–∞:** `users`
- **–ü–æ–ª–µ:** `gender_preference`
- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `NULL`
- **–§—É–Ω–∫—Ü–∏—è:** `clear_gender_preference(user_id)`

### **3. –°–±—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è –ª–∏—á–Ω–æ—Å—Ç–∏**
```sql
UPDATE users SET personality_profile = NULL WHERE id = $1
```
- **–¢–∞–±–ª–∏—Ü–∞:** `users`
- **–ü–æ–ª–µ:** `personality_profile` (JSONB)
- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `NULL`
- **–§—É–Ω–∫—Ü–∏—è:** `clear_personality_profile(user_id)`

### **4. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞**
```python
await self.invalidate_cache(user_id)
```
- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:** –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫—ç—à–∞ FSM
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∑–∏—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î

## üîí –ß—Ç–æ –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è

### **–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
1. **–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö** (`consent_given`) - –æ—Å—Ç–∞–µ—Ç—Å—è `TRUE`
2. **–ü–æ–¥–ø–∏—Å–∫–∞** (`subscription_status`, `subscription_expires_at`) - –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
3. **–Ø–∑—ã–∫** (`language`) - –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º
4. **–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (`username`, `first_name`, `last_name`)
5. **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è** (`created_at`) - –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
6. **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** (`updated_at`) - –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### **–¢–∞–±–ª–∏—Ü–∞ `users`:**
```sql
CREATE TABLE public.users (
    id BIGINT NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    gender_preference TEXT DEFAULT NULL,        -- ‚Üê –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ NULL
    language TEXT DEFAULT 'en',                 -- ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
    subscription_status TEXT DEFAULT 'free',    -- ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
    consent_given BOOLEAN DEFAULT FALSE,        -- ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
    subscription_expires_at TIMESTAMP,          -- ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
    personality_profile JSONB,                  -- ‚Üê –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ NULL
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT users_pkey PRIMARY KEY (id)
);
```

### **–¢–∞–±–ª–∏—Ü–∞ `messages` (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è):**
```sql
CREATE TABLE public.messages (
    id BIGSERIAL NOT NULL,
    user_id BIGINT NOT NULL,
    role TEXT NOT NULL,
    text TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT messages_pkey PRIMARY KEY (id, created_at),
    CONSTRAINT messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE
) PARTITION BY RANGE (created_at);
```
**–£–¥–∞–ª—è—é—Ç—Å—è:** –í–°–ï –∑–∞–ø–∏—Å–∏ —Å `user_id = $1`

## üéØ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ restart

### **1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞:**
```python
cached_data.is_restarted = True
cached_data.is_stopped = False  # Reset stop state
await user_cache.set(user_id, cached_data)
```

### **2. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ:**
```
‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!

–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ...
```

### **3. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É –ø–æ–ª–∞:**
```python
await asyncio.sleep(2)
await callback.message.answer(
    text=i18n.t("gender.choose_gender"),
    reply_markup=get_gender_keyboard(),
    parse_mode="HTML"
)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### **1. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `is_restarted` –≤ –∫—ç—à–µ
- –ï—Å–ª–∏ —É–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### **2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- **–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –¥–∞–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –∑–∞–Ω–æ–≤–æ
- **–ü–æ–¥–ø–∏—Å–∫–∞** - –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- **–Ø–∑—ã–∫** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞ –æ—Å—Ç–∞—é—Ç—Å—è

### **3. –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏:**
- –£–¥–∞–ª—è—é—Ç—Å—è –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞)
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä –ø–æ–ª–∞ –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å /stop

| –ü–∞—Ä–∞–º–µ—Ç—Ä | /restart | /stop |
|----------|----------|-------|
| **–°–æ–æ–±—â–µ–Ω–∏—è** | ‚ùå –£–¥–∞–ª—è—é—Ç—Å—è | ‚ùå –£–¥–∞–ª—è—é—Ç—Å—è |
| **–ü–æ–ª –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞** | ‚ùå –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è | ‚ùå –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è |
| **–ü—Ä–æ—Ñ–∏–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏** | ‚ùå –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è | ‚ùå –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è |
| **–°–æ–≥–ª–∞—Å–∏–µ** | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è |
| **–ü–æ–¥–ø–∏—Å–∫–∞** | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è |
| **–Ø–∑—ã–∫** | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è |
| **–†–µ–∑—É–ª—å—Ç–∞—Ç** | –í—ã–±–æ—Ä –ø–æ–ª–∞ | –ü—Ä–æ—â–∞–Ω–∏–µ |

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–º–∞–Ω–¥–∞ `/restart` –≤—ã–ø–æ–ª–Ω—è–µ—Ç **–º—è–≥–∫–∏–π —Å–±—Ä–æ—Å** —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–£–¥–∞–ª—è–µ—Ç:** –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª–∞ –∏ –ª–∏—á–Ω–æ—Å—Ç–∏
- **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç:** —Å–æ–≥–ª–∞—Å–∏–µ, –ø–æ–¥–ø–∏—Å–∫—É, —è–∑—ã–∫ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –≤—ã–±–æ—Ä—É –ø–æ–ª–∞ –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –ø—Ä–∏ —ç—Ç–æ–º –≤–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏.
