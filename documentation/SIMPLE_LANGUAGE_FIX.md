# Простое исправление проблемы с языком

## Проблема
При выборе языка через кнопки интерфейса язык не сохранялся между сессиями.

## Решение
Используем существующую колонку `language` в таблице `users` для сохранения языковых предпочтений.

## Что было изменено

### 1. UserService (`app/domain/user/services_cached.py`)
Добавлены методы:
- `get_language(user_id)` - получение языка пользователя из базы данных
- `set_language(user_id, language)` - сохранение языка пользователя в базу данных

### 2. Обработчик выбора языка (`app/domain/user/callbacks.py`)
- Теперь сохраняет выбранный язык в базу данных
- Добавлена обработка ошибок

### 3. I18nMiddleware (`app/shared/middlewares/i18n_middleware.py`)
- Теперь сначала проверяет сохраненный язык пользователя в базе данных
- Использует Telegram language_code только как fallback для новых пользователей
- Автоматически сохраняет язык Telegram как предпочтение для новых пользователей

## Как применить исправления

### 1. Инициализируйте языковые предпочтения для существующих пользователей
```bash
python scripts/init_user_languages.py
```

### 2. Перезапустите бота
После применения изменений перезапустите бота для применения изменений в коде.

## Тестирование

После применения исправлений:

1. Выберите язык через кнопки в интерфейсе
2. Отправьте любое сообщение боту
3. Проверьте, что интерфейс остается на выбранном языке
4. Перезапустите бота и проверьте, что язык сохранился

## Результат

✅ **Язык сохраняется в базе данных**  
✅ **Сохраняется между сессиями**  
✅ **Сохраняется после перезапуска бота**  
✅ **Новые пользователи автоматически получают язык на основе Telegram настроек**  

Проблема решена с минимальными изменениями в коде!
