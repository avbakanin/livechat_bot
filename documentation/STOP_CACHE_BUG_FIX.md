# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∫—ç—à–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /stop

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### **–ü—Ä–æ–±–ª–µ–º–∞:**
–í –∫–æ–º–∞–Ω–¥–µ `/stop` –±—ã–ª–∞ **–ª–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞** - –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à **–ø–æ—Å–ª–µ** —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

### **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```python
# 1. –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –∏ –∫—ç—à–∞
await user_service.reset_user_state(user_id)
# ‚Üì –í–Ω—É—Ç—Ä–∏ reset_user_state:
#   - DELETE FROM users WHERE id = $1
#   - await user_cache.invalidate(user_id)

# 2. ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –£–ñ–ï –£–î–ê–õ–ï–ù–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if cached_data:
    cached_data.is_stopped = True
    cached_data.is_restarted = False
    await user_cache.set(user_id, cached_data)  # ‚ùå –û–®–ò–ë–ö–ê!
```

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î
2. ‚úÖ –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è (`user_cache.invalidate`)
3. ‚ùå **–ö–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ `is_stopped` –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### **–ù–æ–≤–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π (–ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```python
# 1. ‚úÖ –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
if cached_data:
    cached_data.is_stopped = True
    cached_data.is_restarted = False
    await user_cache.set(user_id, cached_data)

# 2. ‚úÖ –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –∏ –∫—ç—à–∞
await user_service.reset_user_state(user_id)
# ‚Üì –í–Ω—É—Ç—Ä–∏ reset_user_state:
#   - DELETE FROM users WHERE id = $1
#   - await user_cache.invalidate(user_id)
```

## üéØ –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

### **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
1. **"–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ** - —Ñ–ª–∞–≥ `is_stopped` –º–æ–≥ –æ—Å—Ç–∞—Ç—å—Å—è –≤ –∫—ç—à–µ –Ω–∞–≤—Å–µ–≥–¥–∞
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π** - –∫—ç—à —Å–æ–¥–µ—Ä–∂–∞–ª –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –Ω–æ–≤–æ–º `/start`** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ **–õ–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Å–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º, –ø–æ—Ç–æ–º —É–¥–∞–ª—è–µ–º
2. ‚úÖ **–ß–∏—Å—Ç—ã–π –∫—ç—à** - –Ω–∏–∫–∞–∫–∏—Ö "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –ø—Ä–∏ –Ω–æ–≤–æ–º `/start` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç "—Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞"

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å

### **–§—É–Ω–∫—Ü–∏—è `reset_user_state`:**
```python
async def reset_user_state(self, user_id: int) -> None:
    """Reset user state completely - delete user from database."""
    # Delete all user messages first (due to foreign key constraint)
    await self.delete_user_messages(user_id)
    
    # Delete user completely from database
    await self.delete_user(user_id)  # ‚Üê –ó–¥–µ—Å—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è user_cache.invalidate(user_id)
```

### **–§—É–Ω–∫—Ü–∏—è `delete_user`:**
```python
async def delete_user(self, user_id: int) -> None:
    """Delete user completely from database."""
    async with self.pool.acquire() as conn:
        try:
            await conn.execute(
                "DELETE FROM users WHERE id = $1",
                user_id
            )
            # Remove from cache
            await user_cache.invalidate(user_id)  # ‚Üê –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –∑–¥–µ—Å—å
        except Exception as e:
            raise UserException(f"Error deleting user {user_id}: {e}", e)
```

## üîÑ –ù–æ–≤—ã–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è /stop

### **1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–î–∞" –≤ –¥–∏–∞–ª–æ–≥–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**
### **2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ (–ù–û–í–û–ï):**
```python
cached_data.is_stopped = True
cached_data.is_restarted = False
await user_cache.set(user_id, cached_data)
```

### **3. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```python
await user_service.reset_user_state(user_id)
# ‚Üì –£–¥–∞–ª—è–µ—Ç:
#   - –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#   - –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
#   - –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (user_cache.invalidate)
```

### **4. –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ:**
```
üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **–¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞ `/stop` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
1. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –æ–ø–µ—Ä–∞—Ü–∏–π
2. ‚úÖ **–ß–∏—Å—Ç—ã–π –∫—ç—à** - –Ω–∏–∫–∞–∫–∏—Ö –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** –ø—Ä–∏ –Ω–æ–≤–æ–º `/start`
4. ‚úÖ **–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å** –ø—Ä–æ—Ü–µ—Å—Å–∞

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã:**
- ‚ùå –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î
- ‚ùå –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞
- ‚ùå –ù–∏–∫–∞–∫–∏—Ö —Å–ª–µ–¥–æ–≤ –Ω–µ –æ—Å—Ç–∞–µ—Ç—Å—è

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –æ–ø–µ—Ä–∞—Ü–∏–π.** –¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞ `/stop` —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–≥–∏—á–Ω–æ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. **–û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à** (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
2. **–£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–∏–∑ –ë–î –∏ –∫—ç—à–∞)
3. **–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç**

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã!** ‚úÖ
