# üîÑ –ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å

**–ù–ï–¢, –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ù–ï –±–µ—Ä—É—Ç—Å—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.** –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É (lazy loading)** - –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –Ω–∏–º.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### **1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ (`UserCacheData`):**

```python
@dataclass
class UserCacheData:
    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_id: int
    username: Optional[str] = None
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    
    # –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
    consent_given: bool = False
    gender_preference: str = "female"
    subscription_status: str = "free"
    subscription_expires_at: Optional[datetime] = None
    
    # –°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å
    daily_message_count: int = 0
    last_message_date: str = ""
    
    # –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–∞–Ω–¥
    is_restarted: bool = False
    is_stopped: bool = False
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫—ç—à–∞
    cached_at: datetime
    last_accessed: datetime
```

### **2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—ç—à–∞:**
- **TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏):** 30 –º–∏–Ω—É—Ç
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:** 10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–û—á–∏—Å—Ç–∫–∞:** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### **–≠—Ç–∞–ø 1: Middleware (FSM Middleware)**
```python
# app/shared/fsm/fsm_middleware.py
async def __call__(self, handler, event, data):
    user_id = event.from_user.id
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
    cached_data = await user_cache.get(user_id)
    
    if cached_data:
        # –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –∫—ç—à–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
        data["cached_user"] = cached_data
    else:
        # –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫—ç—à–µ - handlers –∑–∞–≥—Ä—É–∑—è—Ç –∏–∑ –ë–î
        data["cached_user"] = None
```

### **–≠—Ç–∞–ø 2: –ü–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –¥–∞–Ω–Ω—ã–º**
```python
# app/domain/user/services_cached.py
async def get_user_with_cache(self, user_id: int):
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
    cached_data = await user_cache.get(user_id)
    if cached_data:
        return cached_data  # –î–∞–Ω–Ω—ã–µ —É–∂–µ –≤ –∫—ç—à–µ
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    user = await db_get_user(self.pool, user_id)
    if user:
        # –°–æ–∑–¥–∞–µ–º –∫—ç—à-–æ–±—ä–µ–∫—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        cached_data = UserCacheData.from_user(user)
        await user_cache.set(user_id, cached_data)
        return cached_data
```

## üìä –ß—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **–ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î:**
```sql
SELECT id, username, first_name, last_name, gender_preference,
       subscription_status, consent_given, subscription_expires_at,
       created_at, updated_at
FROM users
WHERE id = $1
```

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `users`:**
```sql
CREATE TABLE public.users (
    id BIGINT NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    gender_preference TEXT DEFAULT NULL,
    language TEXT DEFAULT 'en',
    subscription_status TEXT DEFAULT 'free',
    consent_given BOOLEAN DEFAULT FALSE,
    subscription_expires_at TIMESTAMP,
    personality_profile JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT users_pkey PRIMARY KEY (id)
);
```

## ‚ö° –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

### **–ß—Ç–æ –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **‚ùå –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **‚ùå –ü—Ä–æ—Ñ–∏–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏** - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ personality_profile
3. **‚ùå –Ø–∑—ã–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ i18n
4. **‚ùå –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π** - –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

### **–ß—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏:**

1. **‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (id, username, names)
2. **‚úÖ –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è** (gender_preference)
3. **‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏** (subscription_status, expires_at)
4. **‚úÖ –°–æ–≥–ª–∞—Å–∏–µ** (consent_given)
5. **‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏** (created_at, updated_at)

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start
2. FSM Middleware: cached_data = None
3. cmd_start: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç user_exists = False
4. –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
5. –î–∞–Ω–Ω—ã–µ –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. FSM Middleware: cached_data = None (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
3. handle_message: –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ user_service.get_user_with_cache()
4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫—ç—à –Ω–∞ 30 –º–∏–Ω—É—Ç
6. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. FSM Middleware: cached_data = UserCacheData (–∏–∑ –∫—ç—à–∞)
3. handle_message: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç cached_data –Ω–∞–ø—Ä—è–º—É—é
4. –ù–ï–¢ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î
```

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
```python
async def _cleanup_loop(self):
    while True:
        await asyncio.sleep(300)  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        await self._cleanup_expired()  # –£–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏
```

### **–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
await user_cache.invalidate(user_id)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è
await user_cache.update_field(user_id, "subscription_status", "premium")

# –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫—ç—à–∞
await user_cache.clear()
```

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### **1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫** - –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 –º–∏–Ω—É—Ç
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –¥–æ 10,000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **2. –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚úÖ **–ü–∞–º—è—Ç—å** - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–°–µ—Ç—å** - –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- ‚úÖ **CPU** - –º–µ–Ω—å—à–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤

### **3. –ì–∏–±–∫–æ—Å—Ç—å:**
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - TTL 30 –º–∏–Ω—É—Ç
- ‚úÖ **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** - –º–æ–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
- ‚úÖ **–°–µ–ª–µ–∫—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üö® –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### **1. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ** - –¥–æ 30 –º–∏–Ω—É—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
- ‚ö†Ô∏è **–ü–∞–º—è—Ç—å** - –¥–æ 10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ RAM
- ‚ö†Ô∏è **–°–ª–æ–∂–Ω–æ—Å—Ç—å** - –Ω—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

### **2. –û–±—Ö–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:**
```python
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
await user_cache.update_field(user_id, "subscription_status", new_status)

# –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
await user_cache.invalidate(user_id)
```

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–∞ –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—É–º–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**:

- üéØ **–ü–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ** ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
- ‚ö° **–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è** ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞
- üïê **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** ‚Üí –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- üîÑ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** ‚Üí –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç

**–≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö! üöÄ
